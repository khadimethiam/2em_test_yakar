<app-sidebar></app-sidebar>

<div class="container mt-4">
  <!-- Success Message Block -->
  <div *ngIf="showSuccessMessage" class="alert alert-success mt-3">
    {{ successMessage }}
  </div>

  <h2 class="mb-3">
    Liste des utilisateurs 
    <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Liste des utilisateurs enregistrés">?</span>
  </h2>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <!-- Boutons pour filtrer les rôles -->
    <div>
      <button class="btn btn-primary btn-sm me-2" (click)="filterUsers('user')">Utilisateurs simples</button>
      <button class="btn btn-outline-secondary btn-sm me-2" (click)="filterUsers('admin')">Admins</button>
    </div>
  
    <div class="d-flex align-items-center search-container">
      <i class="bi bi-search search-icon"></i> <!-- Icône de recherche (Bootstrap Icons) -->
      <input
        type="text"
        class="form-control form-control-sm"
        placeholder="Rechercher par numéro de téléphone"
        [(ngModel)]="searchPhone"
        (input)="onSearchPhone()"
      />
    </div>
    


    <!-- Bouton Ajouter un utilisateur -->
    <button class="btn btn-success rounded-circle btn-sm" (click)="onAddUser()" data-bs-toggle="tooltip" data-bs-placement="top" title="Ajouter un utilisateur">+</button>
  </div>

 <!-- Formulaire d'ajout d'utilisateur -->
<div *ngIf="showPersonalInfoForm || showAccountForm" class="card shadow-lg mb-4">
  <div class="card-body">
    <h5 class="card-title text-center mb-4">Ajouter un Utilisateur</h5>
    <form (ngSubmit)="showPersonalInfoForm ? onSubmitPersonalInfo() : onSubmitAccountInfo()" #addUserForm="ngForm">
      <!-- Étape 1 : Informations personnelles -->
      <div *ngIf="showPersonalInfoForm">
        <div class="mb-3">
          <label for="nom" class="form-label">Nom</label>
          <input type="text" id="nom" [(ngModel)]="userPersonalInfo.nom" name="nom" class="form-control" placeholder="Saisir le nom" required #nom="ngModel" />
          <div *ngIf="nom.invalid && nom.touched" class="text-danger">Le nom est requis.</div>
        </div>

        <div class="mb-3">
          <label for="prenom" class="form-label">Prénom</label>
          <input type="text" id="prenom" [(ngModel)]="userPersonalInfo.prenom" name="prenom" class="form-control" placeholder="Saisir le prénom" required #prenom="ngModel" />
          <div *ngIf="prenom.invalid && prenom.touched" class="text-danger">Le prénom est requis.</div>
        </div>

        <div class="mb-3">
          <label for="email" class="form-label">Email</label>
          <input type="email" id="email" [(ngModel)]="userPersonalInfo.email" name="email" class="form-control" placeholder="Saisir l'email" required email #email="ngModel" />
          <div *ngIf="email.invalid && email.touched" class="text-danger">Veuillez saisir une adresse email valide.</div>
        </div>

        <div class="mb-3">
          <label for="numero_tel" class="form-label">Numéro de Téléphone</label>
          <input type="tel" id="numero_tel" [(ngModel)]="userPersonalInfo.numero_tel" name="numero_tel" class="form-control" placeholder="Ex: 770123456" required pattern="^[0-9]{9}$" #numero_tel="ngModel" />
          <div *ngIf="numero_tel.invalid && numero_tel.touched" class="text-danger">Numéro invalide (9 chiffres requis).</div>
        </div>
      </div>

      <!-- Étape 2 : Informations de compte -->
      <div *ngIf="showAccountForm">
        <div class="mb-3">
          <label for="password" class="form-label">Mot de Passe</label>
          <div class="input-group">
            <!-- Champ de mot de passe -->
            <input 
              type="{{ showPassword ? 'text' : 'password' }}" 
              id="password" 
              [(ngModel)]="userAccountInfo.password" 
              name="password" 
              class="form-control" 
              placeholder="Mot de passe" 
              required 
              minlength="6" 
              #password="ngModel" />
        
            <!-- Icône pour afficher/masquer le mot de passe -->
            <span class="input-group-text" (click)="togglePasswordVisibility()">
              <i class="bi" [ngClass]="showPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
            </span>
          </div>
          <div *ngIf="password.invalid && password.touched" class="text-danger">Le mot de passe doit avoir au moins 6 caractères.</div>
        </div>

        <div class="mb-3">
          <label for="role" class="form-label">Rôle</label>
          <select id="role" [(ngModel)]="userAccountInfo.role" name="role" class="form-select" required #role="ngModel">
            <option value="user">Utilisateur</option>
            <option value="admin">Admin</option>
          </select>
          <div *ngIf="role.invalid && role.touched" class="text-danger">Le rôle est requis.</div>
        </div>

        <div class="mb-3">
          <label for="photo" class="form-label">Photo</label>
          <input type="file" id="photo" (change)="onFileChange($event)" class="form-control" />
        </div>
      </div>

      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-danger btn-sm" (click)="cancel()">Annuler</button>
        <button type="submit" class="btn btn-primary btn-sm" [disabled]="addUserForm.invalid">{{ showPersonalInfoForm ? 'Suivant' : 'Enregistrer' }}</button>
      </div>
    </form>
  </div>
</div>

 <!-- Tableau des utilisateurs -->
<div *ngIf="!showPersonalInfoForm && !showAccountForm">
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>Prénom</th>
          <th>Nom</th>
          <th>Email</th>
          <th>Téléphone</th>
          <th>Status</th>
          <th>Rôle</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users">
          <td>{{ user.prenom }}</td>
          <td>{{ user.nom }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.numero_tel }}</td>
          <td>
            <button 
              class="status-button" 
              [ngClass]="{
                'active': user.status === 'actif', 
                'inactive': user.status === 'inactif'
              }"
              (click)="onStatusChange(user)">
              {{ user.status }}
            </button>
          </td>
          <td>
            <!-- Switch pour gérer le rôle -->
            <div class="d-flex align-items-center">
              <div class="form-check form-switch me-2">
                <input class="form-check-input" type="checkbox" [checked]="user.role === 'admin'" (change)="onRoleChange(user, $event)" />
              </div>
              <!-- Texte affiché en fonction du rôle -->
              <span>{{ user.role === 'admin' ? 'Admin' : 'Utilisateur' }}</span>
            </div>
          </td>
          <td>
            <button class="btn btn-outline-primary btn-sm">                
              <i class="fas fa-edit"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

<!-- Modal de confirmation -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content">
      <!-- En-tête du modal -->
      <div class="modal-header bg-white">
        <h5 class="modal-title" id="confirmationModalLabel">Confirmation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <!-- Corps du modal -->
      <div class="modal-body text-center">
        <div class="mb-4">
          <img src="/images/int.png" alt="Question Icon" style="width: 60px; height: auto;">
        </div>
        <p class="fs-5 fw-semibold mb-4">
          Voulez-vous vraiment bloquer l'utilisateur {{ selectedUser ? selectedUser.prenom + ' ' + selectedUser.nom : '' }} ?
        </p>
      </div>
      
      <!-- Pied du modal avec boutons alignés horizontalement -->
      <div class="modal-footer d-flex justify-content-between align-items-center border-0">
        <button type="button" class="btn btn-danger fw-bold px-4" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary fw-bold px-4" (click)="confirmStatusChange()">Confirmer</button>
      </div>
    </div>
  </div>
</div>

    <!-- Pagination -->
    <nav *ngIf="totalPages > 1" class="mt-3">
      <ul class="pagination justify-content-center">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <button class="page-link" (click)="previousPage()">Précédent</button>
        </li>
        <li *ngFor="let page of getPageNumbers()" class="page-item" [class.active]="page === currentPage">
          <button class="page-link" (click)="goToPage(page)">{{ page }}</button>
        </li>
        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <button class="page-link" (click)="nextPage()">Suivant</button>
        </li>
      </ul>
    </nav>
  </div>
</div>
